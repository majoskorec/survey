import { Controller } from '@hotwired/stimulus';
import Sortable from 'sortablejs'

/**
 * this code was generated by ChatGPT
 * its works, so I don't reviewed it deeply
 */
export default class extends Controller {
    connect() {
        // list je priamo element s data-controller (div#Survey_questions)
        this.list = this.element

        // inicializácia
        this.ensureHandles()
        this.initSortable()
        this.reindex()

        // Sleduj zmeny vo vnútri (pridanie/odstránenie položiek EA tlačidlami)
        this.observer = new MutationObserver(() => {
            this.ensureHandles()
            this.reindex()
        })
        this.observer.observe(this.list, { childList: true, subtree: true })
    }

    disconnect() {
        if (this.sortable) this.sortable.destroy()
        if (this.observer) this.observer.disconnect()
    }

    initSortable() {
        if (this.sortable) this.sortable.destroy()

        this.sortable = Sortable.create(this.list, {
            draggable: '.field-collection-item',
            handle: '.drag-handle',
            animation: 150,
            onEnd: () => this.reindex(),
        })
    }

    items() {
        // priame deti s triedou .field-collection-item (bez vnorených)
        return Array.from(this.list.children).filter(el =>
            el.classList?.contains('field-collection-item')
        )
    }

    ensureHandles() {
        // vlož handle do headeru ak chýba
        this.items().forEach(item => {
            const header = item.querySelector('.accordion-header')
            if (!header) return

            if (!header.querySelector('.drag-handle')) {
                const h = document.createElement('span')
                h.className = 'drag-handle'
                h.title = 'Order'
                h.setAttribute('aria-hidden', 'true')
                h.innerText = '⠿'

                header.appendChild(h)
            }

            const collapse = header.querySelector('button.accordion-button')
            if (collapse) {
                collapse.className += ' with-drag-handle'
            }
        })
    }

    reindex() {
        this.items().forEach((item, idx) => {
            // hľadaj hidden input orderIndex v danej položke
            const input =
                item.querySelector('input[name$="[orderIndex]"]') ||
                item.querySelector('input[id$="_orderIndex"]')
            if (input) input.value = idx + 1

            // voliteľné: aktualizuj aj text v akordeóne "#<n>: ..."
            const btn = item.querySelector('.accordion-button')
            if (btn) {
                btn.firstChild?.nodeType === Node.TEXT_NODE
                    ? (btn.firstChild.textContent = ` #${idx + 1}: `)
                    : btn.insertBefore(document.createTextNode(` #${idx + 1}: `), btn.firstChild)
            }
        })
    }
}
